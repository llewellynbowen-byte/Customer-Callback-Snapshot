import React, { useState, useEffect, useRef } from 'react';
import { 
  FileText, 
  Upload, 
  CheckCircle, 
  AlertCircle, 
  Play, 
  ShieldCheck, 
  User, 
  ChevronRight, 
  Trash2,
  Loader2,
  ExternalLink,
  MessageSquare,
  BarChart3
} from 'lucide-react';

const SYSTEM_PROMPT = `
# ROLE
You are the "Customer Callback Intelligence Analyst & Playbook Compliance Auditor."

Your job is to analyze customer call transcripts and produce a concise, operator-ready Customer Profile Snapshot.

# OBJECTIVE
Generate:
1) A complete 10-section Customer Profile Snapshot (Callback Intelligence Monitoring Framework).
2) A Callback Playbook Compliance Audit.

# HARD RULES
- Do NOT invent facts. If information is missing, explicitly state "Unknown."
- Support classifications with short direct quotes (≤20 words).
- Use exactly the 10 sections below, in order.
- No emojis.
- Keep output concise and scannable.

# OUTPUT STRUCTURE (FOLLOW EXACTLY)
## CUSTOMER PROFILE SNAPSHOT
---
## SECTION 1: CALL CONTEXT & HISTORY
... (sections 1-10 as defined in the framework) ...

# CALLBACK PLAYBOOK COMPLIANCE AUDIT
## A) PLAYBOOK SELECTION
...
## B) PLAYBOOK EXECUTION CHECK
...
## C) COMPLIANCE SUMMARY
...
`;

const App = () => {
  const [apiKey, setApiKey] = useState("");
  const [transcripts, setTranscripts] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [selectedResult, setSelectedResult] = useState(null);
  const [inputText, setInputText] = useState("");
  const [activeTab, setActiveTab] = useState('input'); // 'input' or 'results'

  // Handle Text Paste
  const handleAddText = () => {
    if (!inputText.trim()) return;
    const newFile = {
      id: crypto.randomUUID(),
      name: `Pasted Transcript ${transcripts.length + 1}`,
      content: inputText,
      status: 'pending',
      result: null
    };
    setTranscripts([...transcripts, newFile]);
    setInputText("");
  };

  // Handle File Upload
  const handleFileUpload = (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (event) => {
        const newFile = {
          id: crypto.randomUUID(),
          name: file.name,
          content: event.target.result,
          status: 'pending',
          result: null
        };
        setTranscripts(prev => [...prev, newFile]);
      };
      reader.readAsText(file);
    });
  };

  const removeTranscript = (id) => {
    setTranscripts(transcripts.filter(t => t.id !== id));
    if (selectedResult?.id === id) setSelectedResult(null);
  };

  const processTranscript = async (transcript) => {
    const updateStatus = (status, result = null) => {
      setTranscripts(prev => prev.map(t => 
        t.id === transcript.id ? { ...t, status, result } : t
      ));
    };

    updateStatus('processing');

    const callGemini = async (retryCount = 0) => {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Transcript to analyze:\n${transcript.content}` }] }],
            systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
          })
        });

        if (!response.ok) throw new Error('API request failed');
        
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!text) throw new Error('Empty response');
        
        updateStatus('completed', text);
      } catch (error) {
        if (retryCount < 5) {
          const delay = Math.pow(2, retryCount) * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
          return callGemini(retryCount + 1);
        }
        updateStatus('error', "Failed to evaluate transcript. Please try again.");
      }
    };

    await callGemini();
  };

  const processAll = async () => {
    setIsProcessing(true);
    const pending = transcripts.filter(t => t.status === 'pending');
    for (const t of pending) {
      await processTranscript(t);
    }
    setIsProcessing(false);
    setActiveTab('results');
  };

  const renderSection = (title, content) => (
    <div className="mb-8 last:mb-0">
      <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-700 pb-1">
        {title}
      </h3>
      <div className="text-slate-200 whitespace-pre-wrap leading-relaxed text-sm">
        {content}
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-950 text-slate-50 font-sans selection:bg-indigo-500/30">
      {/* Header */}
      <header className="border-b border-slate-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
              <ShieldCheck className="w-5 h-5 text-white" />
            </div>
            <h1 className="text-xl font-bold tracking-tight">AI Customer Snapshot</h1>
          </div>
          <div className="flex gap-4">
            <button 
              onClick={() => setActiveTab('input')}
              className={`px-4 py-2 text-sm font-medium transition-colors ${activeTab === 'input' ? 'text-white border-b-2 border-indigo-500' : 'text-slate-400 hover:text-white'}`}
            >
              Analyze
            </button>
            <button 
              onClick={() => setActiveTab('results')}
              className={`px-4 py-2 text-sm font-medium transition-colors ${activeTab === 'results' ? 'text-white border-b-2 border-indigo-500' : 'text-slate-400 hover:text-white'}`}
            >
              Snapshots ({transcripts.filter(t => t.status === 'completed').length})
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-8">
        {activeTab === 'input' ? (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Left Column: Upload */}
            <div className="lg:col-span-1 space-y-6">
              <div className="bg-slate-900 border border-slate-800 rounded-xl p-6 shadow-xl">
                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                  <Upload className="w-5 h-5 text-indigo-400" />
                  Import Calls
                </h2>
                
                <div className="space-y-4">
                  <div className="relative group">
                    <input 
                      type="file" 
                      multiple 
                      onChange={handleFileUpload}
                      className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                      accept=".txt,.md"
                    />
                    <div className="border-2 border-dashed border-slate-700 group-hover:border-indigo-500/50 group-hover:bg-indigo-500/5 rounded-xl p-8 text-center transition-all">
                      <FileText className="w-10 h-10 text-slate-600 group-hover:text-indigo-400 mx-auto mb-3" />
                      <p className="text-sm text-slate-400 group-hover:text-slate-300">
                        Drag & drop transcripts here or <span className="text-indigo-400">browse</span>
                      </p>
                      <p className="text-[10px] text-slate-500 mt-2">Supports .txt, .docx (paste), .md</p>
                    </div>
                  </div>

                  <div className="relative">
                    <textarea 
                      placeholder="Or paste transcript text directly here..."
                      className="w-full bg-slate-950 border border-slate-800 rounded-lg p-4 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all min-h-[120px]"
                      value={inputText}
                      onChange={(e) => setInputText(e.target.value)}
                    />
                    <button 
                      onClick={handleAddText}
                      disabled={!inputText.trim()}
                      className="mt-2 w-full bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed py-2 rounded-lg text-sm font-medium transition-colors"
                    >
                      Add Paste to Queue
                    </button>
                  </div>
                </div>
              </div>

              {transcripts.length > 0 && (
                <button 
                  onClick={processAll}
                  disabled={isProcessing || transcripts.every(t => t.status === 'completed')}
                  className="w-full bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-800 py-4 rounded-xl font-bold text-white shadow-lg shadow-indigo-900/20 flex items-center justify-center gap-2 transition-all active:scale-[0.98]"
                >
                  {isProcessing ? (
                    <><Loader2 className="w-5 h-5 animate-spin" /> Analyzing Batch...</>
                  ) : (
                    <><Play className="w-5 h-5" /> Run Intelligence Audit</>
                  )}
                </button>
              )}
            </div>

            {/* Right Column: Queue */}
            <div className="lg:col-span-2">
              <div className="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-xl">
                <div className="px-6 py-4 border-b border-slate-800 flex justify-between items-center">
                  <h2 className="font-semibold">Batch Queue ({transcripts.length})</h2>
                  {transcripts.length > 0 && (
                    <button onClick={() => setTranscripts([])} className="text-xs text-slate-500 hover:text-red-400">Clear All</button>
                  )}
                </div>
                <div className="divide-y divide-slate-800 max-h-[600px] overflow-y-auto">
                  {transcripts.length === 0 ? (
                    <div className="p-12 text-center">
                      <MessageSquare className="w-12 h-12 text-slate-800 mx-auto mb-4" />
                      <p className="text-slate-500">No transcripts loaded yet.</p>
                    </div>
                  ) : (
                    transcripts.map((t) => (
                      <div key={t.id} className="p-4 flex items-center justify-between hover:bg-slate-800/50 transition-colors">
                        <div className="flex items-center gap-4 flex-1 min-w-0">
                          <div className={`w-2 h-2 rounded-full ${
                            t.status === 'completed' ? 'bg-green-500' : 
                            t.status === 'processing' ? 'bg-yellow-500 animate-pulse' : 
                            t.status === 'error' ? 'bg-red-500' : 'bg-slate-600'
                          }`} />
                          <div className="flex-1 min-w-0">
                            <h4 className="text-sm font-medium truncate">{t.name}</h4>
                            <p className="text-xs text-slate-500">
                              {t.status.charAt(0).toUpperCase() + t.status.slice(1)}
                            </p>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          {t.status === 'completed' && (
                            <button 
                              onClick={() => { setSelectedResult(t); setActiveTab('results'); }}
                              className="px-3 py-1 bg-indigo-500/10 text-indigo-400 text-xs rounded hover:bg-indigo-500/20"
                            >
                              View Snapshot
                            </button>
                          )}
                          <button 
                            onClick={() => removeTranscript(t.id)}
                            className="p-2 text-slate-500 hover:text-red-400 transition-colors"
                          >
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
            {/* Sidebar: List of results */}
            <div className="lg:col-span-1 space-y-4">
              <h3 className="text-xs font-bold text-slate-500 uppercase px-2">Processed Calls</h3>
              <div className="space-y-1">
                {transcripts.filter(t => t.status === 'completed').map(t => (
                  <button
                    key={t.id}
                    onClick={() => setSelectedResult(t)}
                    className={`w-full text-left p-3 rounded-lg text-sm transition-all flex items-center justify-between group ${
                      selectedResult?.id === t.id 
                      ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/20' 
                      : 'bg-slate-900 text-slate-400 hover:bg-slate-800'
                    }`}
                  >
                    <span className="truncate flex-1">{t.name}</span>
                    <ChevronRight className={`w-4 h-4 transition-transform ${selectedResult?.id === t.id ? 'translate-x-1' : 'opacity-0 group-hover:opacity-100'}`} />
                  </button>
                ))}
                {transcripts.filter(t => t.status === 'completed').length === 0 && (
                  <p className="text-sm text-slate-600 italic px-2">No audits completed yet.</p>
                )}
              </div>
            </div>

            {/* Main Result Area */}
            <div className="lg:col-span-3">
              {selectedResult ? (
                <div className="bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
                  <div className="bg-indigo-600 px-8 py-6 flex justify-between items-center">
                    <div>
                      <h2 className="text-2xl font-black text-white uppercase tracking-tight">Customer Profile Snapshot</h2>
                      <p className="text-indigo-100 text-xs mt-1 font-medium flex items-center gap-2">
                        <BarChart3 className="w-3 h-3" />
                        CALCULATION ENGINE v2.5-FLASH
                      </p>
                    </div>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => window.print()}
                        className="bg-white/10 hover:bg-white/20 p-2 rounded-lg text-white transition-colors"
                      >
                        <ExternalLink className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                  
                  <div className="p-8 lg:p-12">
                    {selectedResult.result.split('\n## ').map((section, idx) => {
                      if (idx === 0) return null;
                      const lines = section.split('\n');
                      const title = lines[0].replace('---', '').trim();
                      const content = lines.slice(1).join('\n').trim();
                      
                      return (
                        <div key={idx} className="mb-10 last:mb-0">
                          <h3 className="text-indigo-400 font-black text-xs uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span>
                            {title}
                          </h3>
                          <div className="bg-slate-950/50 border border-slate-800 rounded-xl p-6 prose prose-invert prose-sm max-w-none">
                            {content.split('\n').map((line, lIdx) => (
                              <p key={lIdx} className="mb-2 last:mb-0 text-slate-300">
                                {line.startsWith('- ') ? (
                                  <span className="flex gap-2">
                                    <span className="text-indigo-500 mt-1.5 w-1 h-1 rounded-full bg-indigo-500 shrink-0"></span>
                                    <span>{line.substring(2)}</span>
                                  </span>
                                ) : line}
                              </p>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ) : (
                <div className="h-full min-h-[400px] flex flex-col items-center justify-center border-2 border-dashed border-slate-800 rounded-2xl bg-slate-900/20">
                  <BarChart3 className="w-16 h-16 text-slate-800 mb-4" />
                  <p className="text-slate-500 font-medium">Select an audit result to view the Intelligence Snapshot</p>
                </div>
              )}
            </div>
          </div>
        )}
      </main>

      {/* Footer / Stats */}
      <footer className="mt-12 border-t border-slate-800 py-6 text-center text-slate-600 text-xs">
        <p>AI Customer Snapshot • Built for Playbook Compliance & Callback Intelligence</p>
      </footer>
    </div>
  );
};

export default App;